'use strict';window.tsfMedia=function(a){const b="undefined"!=typeof tsfMediaL10n&&tsfMediaL10n;let c={};const d=d=>{let f=a(d.target);if(f.prop("disabled")||"undefined"==typeof wp.media)return d.preventDefault(),void d.stopPropagation();let i,j=f.data("input-type"),k=f.data("input-id");d.preventDefault(),d.stopPropagation(),g();let l={suggestedWidth:f.data("width")||1200,suggestedHeight:f.data("height")||630,isFlex:"undefined"==typeof f.data("flex")?1:f.data("flex"),minWidth:"undefined"==typeof f.data("minWidth")?200:f.data("minWidth"),minHeight:"undefined"==typeof f.data("minHeight")?200:f.data("minHeight")};c.control={params:{flex_width:l.isFlex?4096:0,flex_height:l.isFlex?4096:0,width:l.suggestedWidth,height:l.suggestedHeight,isFlex:l.isFlex,minWidth:l.minWidth,minHeight:l.minHeight}},i=wp.media({button:{text:b.labels[j].imgFrameButton,close:!1},states:[new wp.media.controller.Library({title:b.labels[j].imgFrameTitle,library:wp.media.query({type:"image"}),multiple:!1,date:!1,priority:20,suggestedWidth:l.suggestedWidth,suggestedHeight:l.suggestedHeight}),new c({imgSelectOptions:h})]});const m=function(){i.setState("cropper")};i.off("select",m),i.on("select",m);const n=function(b){let c=b.url,d=b.id;a("#"+k+"-url").val(c).trigger("change"),a("#"+k+"-id").val(d).trigger("change")};i.off("cropped",n),i.on("cropped",n);const o=function(b){let c=b.get("url"),d=b.get("id");a("#"+k+"-url").val(c).trigger("change"),a("#"+k+"-id").val(d).trigger("change")};i.off("skippedcrop",o),i.on("skippedcrop",o);const p=function(){a("#"+k+"-select").text(b.labels[j].imgChange),a("#"+k+"-url").prop("readonly",!0).css("opacity",0).animate({opacity:1},{queue:!0,duration:1e3},"swing"),e(f,{id:k,type:j},!0),tsfAys&&tsfAys.registerChange()};i.off("skippedcrop cropped",p),i.on("skippedcrop cropped",p),i.open()},e=(c,d,e)=>{if(c&&d.id&&!a("#"+d.id+"-remove").length){let f=document.createElement("button");f.type="button",f.id=d.id+"-remove",f.dataset.inputId=d.id,f.dataset.inputType=d.type,f.title=tsf.decodeEntities(b.labels[d.type].imgRemoveTitle),f.innerHTML=tsf.escapeString(b.labels[d.type].imgRemove),f.classList.add("tsf-remove-image-button","button","button-small"),c.after(f),e&&a("#"+d.id+"-remove").css("opacity",0).animate({opacity:1},{queue:!0,duration:1e3})}l()},f=c=>{let d=a(c.target).data("input-id"),e=a(c.target).data("input-type");if(!a("#"+d+"-select").prop("disabled")){a("#"+d+"-select").addClass("disabled").prop("disabled",!0),a("#"+d+"-remove").addClass("disabled").prop("disabled",!0).fadeOut(500,function(){a(this).remove(),a("#"+d+"-select").text(b.labels[e].imgSelect).removeClass("disabled").removeProp("disabled")});let c=a("#"+d+"-url");c.val("").trigger("change"),c.data("readonly")||c.removeProp("readonly"),c.css("opacity",0).animate({opacity:1},{queue:!0,duration:500},"swing"),a("#"+d+"-id").val("").trigger("change"),tsfAys&&tsfAys.registerChange()}},g=()=>{if("undefined"!=typeof c.control)return;let a,d,e=wp.media.controller,f=wp.media.view;d=f.Cropper.extend({className:"crop-content tsf-image",ready:function(){f.Cropper.prototype.ready.apply(this,arguments)},onImageLoad:function(){let a,b=this.controller.get("imgSelectOptions");"function"==typeof b&&(b=b(this.options.attachment,this.controller)),"undefined"==typeof b.aspectRatio&&(b=_.extend(b,{parent:this.$el,onInit:function(){this.parent.children().on("mousedown touchstart",function(b){b.shiftKey?a.setOptions({aspectRatio:"1:1"}):a.setOptions({aspectRatio:!1})})}})),this.trigger("image-loaded"),a=this.controller.imgSelect=this.$image.imgAreaSelect(b)}}),a=e.Cropper.extend({createCropContent:function(){this.cropperView=new d({controller:this,attachment:this.get("selection").first()}),this.cropperView.on("image-loaded",this.createCropToolbar,this),this.frame.content.set(this.cropperView)},doCrop:function(a){var d=Math.round;let e=a.get("cropDetails"),f=c.control;if(f.params.flex_width&&f.params.flex_height)if(e.width===e.height)e.width>f.params.flex_width&&(e.dst_width=e.dst_height=f.params.flex_width);else if(e.width>f.params.flex_width||e.height>f.params.flex_height)if(e.width>e.height){let a=e.width/f.params.flex_width;e.dst_width=f.params.flex_width,e.dst_height=d(e.height/a)}else{let a=e.height/f.params.flex_height;e.dst_height=f.params.flex_height,e.dst_width=d(e.width/a)}return"undefined"==typeof e.dst_width&&(e.dst_width=0,e.dst_height=0),wp.ajax.post("tsf-crop-image",{nonce:b.nonce,id:a.get("id"),context:"tsf-image",cropDetails:e})}}),a.prototype.control={},c=a},h=(a,b)=>{let d,e,f,g,h=c.control,j=!!parseInt(h.params.flex_width,10),k=!!parseInt(h.params.flex_height,10),l=parseInt(h.params.width,10),m=parseInt(h.params.height,10),n=a.get("width"),o=a.get("height"),p=l/m,q=l,r=m;return g=h.params.isFlex?!i(h.params.flex_width,h.params.flex_height,n,o):p===n/o,b.set("control",h.params),b.set("canSkipCrop",g),n/o>p?(m=o,l=m*p):(l=n,m=l/p),d=(n-l)/2,e=(o-m)/2,f={handles:!0,keys:!0,instance:!0,persistent:!0,imageWidth:n,imageHeight:o,minWidth:q>l?l:q,minHeight:r>m?m:r,x1:d,y1:e,x2:l+d,y2:m+e},h.params.isFlex?k||j?(k&&(f.minHeight=h.params.minHeight,f.maxWidth=n),j&&(f.minWidth=h.params.minWidth,f.maxHeight=o)):f.aspectRatio=l+":"+m:(f.handles="corners",f.aspectRatio=l+":"+m),f},i=(a,b,c,d)=>!(c<=a&&d<=b),j=()=>{let c=a(".tsf-set-image-button");if(c.length){let d="",f="",g="";a.each(c,function(c,h){d=a(h).data("input-id"),f=a(h).data("input-type"),g=a("#"+d+"-id"),g.length&&0<g.val()&&(a("#"+d+"-url").prop("readonly",!0),e(a(h),{id:d,type:f},!1)),a("#"+d+"-url").val()&&a("#"+d+"-select").text(b.labels[f].imgChange)})}},k=()=>{a(".tsf-set-image-button").off("click",d).on("click",d)},l=()=>{a(".tsf-remove-image-button").off("click",f).on("click",f)},m=()=>{k(),l(),a(".tsf-enable-media-if-js").removeProp("disabled").removeClass("tsf-enable-media-if-js")},n=()=>{let b=[];const c=c=>{let d=c.target.id||c.target.name||1,e=document.getElementById(c.data.preview);e&&(clearTimeout(b[d]),b[d]=setTimeout(()=>{let b=c.target.value||c.target.placeholder||"";return b.length?void(e.dataset.desc="<img src='"+tsf.escapeString(b)+"' style="+`max-width:${"225px"};max-height:${"225px"};min-width:60px;min-height:60px;border-radius:3px;display:block;`+" />",a(e).not(":visible").fadeIn(250),new Image().src=b,tsfTT.triggerUpdate(e)):void a(e).fadeOut(250)},500))};a(".tsf-image-preview").each((b,d)=>{let e=document.getElementById(d.dataset.for+"-url");a(e).on("input.tsfMediaTooltip change.tsfMediaTooltip",{preview:d.id},c).trigger("change.tsfMediaTooltip")})};return Object.assign({load:()=>{a(document.body).ready(m),a(document.body).ready(j),a(document.body).on("tsf-ready",n)}},{},{l10n:b})}(jQuery),jQuery(window.tsfMedia.load);
